<!DOCTYPE html>
<html>
<head>
<title>GlobalPinger</title>

<script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2/dist/Chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@0.5.7/chartjs-plugin-annotation.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.bundle.js"></script>-->

<!--<script src="https://cdn.jsdelivr.net/combine/npm/chart.js@2,npm/moment@2"></script>-->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>

<style>
.region{
font-weight: bold;
font-size:x-large;
}
.hostname{
font-family:monospace;
}
.instutution{}
.code{
font-family:monospace;
background:#DDD;
}

#graphs{
    display:flex;
    flex-direction: row;
    flex-wrap: wrap;
}
#graphs > div{
    border: 1px solid #000;
    padding:8px;
}
</style>
</head>

<body>

<h1>Overseas Internet Congestion Monitor</h1>

<p>
This server pings some servers around the globe to test how reliable the international internet connection is.<br>
The servers were chosen manually from <a href="https://launchpad.net/ubuntu/+archivemirrors">Ubuntu's Archive mirrors.</a> <br>
Command run is <span class="code">ping -q -c 100 -i 1 HOSTNAME</span>  (runs every ~50min) <br>
This server's ISP is SK Broadband in Korea.
</p>

<div id="graphs">

<div id="korea">
<span class="region">Korea</span> <br>
<span class="institution">NeoWiz</span> <br>
<span class="hostname">ftp.neowiz.com</span>
<canvas class="chartcanvas" id="cc_neowiz" width="600" height="300"></canvas>
</div>

<div id="japan">
<span class="region">Japan</span> <br>
<span class="institution">JAIST</span> <br>
<span class="hostname">ftp.jaist.ac.jp</span>
<canvas class="chartcanvas" id="cc_jaist" width="600" height="300"></canvas>
</div>

<div id="china">
<span class="region">China</span> <br>
<span class="institution">DevCloud</span> <br>
<span class="hostname">mirrors.huaweicloud.com</span>
<canvas class="chartcanvas" id="cc_devcloud" width="600" height="300"></canvas>
</div>

<div id="singapore">
<span class="region">Singapore</span> <br>
<span class="institution">Andrew Yong</span> <br>
<span class="hostname">mirror.0x.sg</span>
<canvas class="chartcanvas" id="cc_ayong" width="600" height="300"></canvas>
</div>

<div id="usa_west">
<span class="region">USA - West</span> <br>
<span class="institution">University of California at Davis</span> <br>
<span class="hostname">mirror.math.ucdavis.edu</span>
<canvas class="chartcanvas" id="cc_ucdavis" width="600" height="300"></canvas>
</div>

<div id="usa_east">
<span class="region">USA - East</span> <br>
<span class="institution">University of Maryland</span> <br>
<span class="hostname">mirror.umd.edu</span>
<canvas class="chartcanvas" id="cc_umd" width="600" height="300"></canvas>
</div>

<div id="uk">
<span class="region">UK</span> <br>
<span class="institution">IT Services, University of Oxford</span> <br>
<span class="hostname">mirror.ox.ac.uk</span>
<canvas class="chartcanvas" id="cc_oxford" width="600" height="300"></canvas>
</div>

<div id="austraila">
<span class="region">Austraila</span> <br>
<span class="institution">Melbourne IT</span> <br>
<span class="hostname">ubuntu.melbourneitmirror.net</span>
<canvas class="chartcanvas" id="cc_melbournit" width="600" height="300"></canvas>
</div>

<div id="8888">
<span class="region">Google</span> <br>
<span class="institution">Google DNS</span> <br>
<span class="hostname">8.8.8.8</span>
<canvas class="chartcanvas" id="cc_8888" width="600" height="300"></canvas>
</div>

</div>

<script>

function setupChart(chart_id, csv_path){
    var ctx=document.getElementById(chart_id).getContext("2d");

    var darray_rtt=[];
    var darray_lrate=[];

    var now_d=new Date();

    var tomm_d=new Date(new Date().setHours(0,0,0,0)+24*60*60*1000);
    var tomm_s=(tomm_d.getMonth()+1)+"/"+tomm_d.getDate();

    var today_d=new Date(new Date().setHours(0,0,0,0));
    var today_s=(today_d.getMonth()+1)+"/"+today_d.getDate();
    var today_center_d=new Date(new Date().setHours(0,0,0,0)+24*60*60*1000*0.5);

    var yesterday_d=new Date(new Date().setHours(0,0,0,0)-24*60*60*1000);
    var yesterday_s=(yesterday_d.getMonth()+1)+"/"+yesterday_d.getDate();
    var yesterday_center_d=new Date(new Date().setHours(0,0,0,0)-24*60*60*1000*0.5);

    var tda_d=new Date(new Date().setHours(0,0,0,0)-24*60*60*1000*2);
    var tda_s=(tda_d.getMonth()+1)+"/"+tda_d.getDate();
    var tda_center_d=new Date(new Date().setHours(0,0,0,0)-24*60*60*1000*1.5);

    var chart = new Chart(ctx, {
        type: 'scatter',


        data: {
            datasets: [{
                label: 'avg RTT',
                backgroundColor: '#22F',
                borderColor: '#22F',
                data: darray_rtt,
                xAsixID:"xax_time",
                yAxisID:"yax_rtt"
            },
            {
                label: 'Loss %',
                backgroundColor: '#F22',
                borderColor: '#F22',
                data: darray_lrate,
                xAsixID:"xax_time",
                yAxisID:"yax_lrate"
            }]
        },

        options: {
            responsive:false,
            scales: {
                xAxes: [{
                    id:"xax_time",
                    type: 'time',
                    position: 'bottom',
                    bounds:"ticks",
                    ticks:{
                      min:tda_d,
                      max:tomm_d
                    },
                    time: {
                        unit:"hour",
                        stepSize:6,
                        displayFormats:{
                            hour:"HH"//"M/D HH:mm"
                        }
                    }
                }],
                yAxes: [
                    {
                        id:"yax_rtt",
                        type:"linear",
                        position:"left",
                        ticks:{
                            suggestedMin:0,
                            suggestedMax:400,
                            stepSize:100,
                            fontColor:"#22F",
                            callback: function(value, index, values) {
                                return value+"ms";
                            }
                        }
                    },
                    {
                        id:"yax_lrate",
                        type:"linear",
                        position:"right",
                        ticks:{
                            suggestedMin:0,
                            suggestedMax:40,
                            stepSize:10,
                            fontColor:"#F22",
                            callback: function(value, index, values) {
                                return value+"%";
                            }
                        }
                    }
                ]
            },
            annotation:{
                annotations:[
                    {
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#000",
                        drawTime:"beforeDatasetsDraw",
                        value:today_d
                    },{
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#000",
                        drawTime:"beforeDatasetsDraw",
                        value:yesterday_d
                    },
                    {
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#0000",
                        drawTime:"beforeDatasetsDraw",
                        value:today_center_d,
                        label:{
                            content:today_s,
                            enabled:true,
                            position:"center",
                            backgroundColor:"#0000",
                            fontColor:"#000"
                        }
                    },
                    {
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#0000",
                        drawTime:"beforeDatasetsDraw",
                        value:tda_center_d,
                        label:{
                            content:tda_s,
                            enabled:true,
                            position:"center",
                            backgroundColor:"#0000",
                            fontColor:"#000"
                        }
                    },
                    {
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#0000",
                        drawTime:"beforeDatasetsDraw",
                        value:yesterday_center_d,
                        label:{
                            content:yesterday_s,
                            enabled:true,
                            position:"center",
                            backgroundColor:"#0000",
                            fontColor:"#000"
                        }
                    },
                    {
                        type:"line",
                        mode:"vertical",
                        scaleID:"xax_time",
                        borderColor:"#2F2",
                        drawTime:"beforeDatasetsDraw",
                        value:now_d,
                        label:{
                            content:"now",
                            enabled:true,
                            position:"top"
                        }
                    }
                ]
            }
        },
    });

    function dataToChart(datapoints){
            for (var i=0;i<datapoints.length;i++){
                //console.log(datapoints[i]);
                var t=new Date(datapoints[i].timestamp*1000)
                darray_rtt.push({
                    'x':t,
                    'y':datapoints[i].rtt_avg
                });
                darray_lrate.push({
                    'x':t,
                    'y':datapoints[i].lossrate*100
                });
                chart.update();
            }
        }

    Papa.parse(csv_path, {
        download: true,
        header:true,
        skipEmptyLines:true,
        complete: function(results) {
                //console.log(results);

                datapoints=results.data;

                dataToChart(datapoints);
            }
    });
}

setupChart("cc_neowiz", "adata/neowiz.csv");
setupChart("cc_jaist", "adata/jaist.csv");
setupChart("cc_devcloud", "adata/devcloud.csv");
setupChart("cc_ayong", "adata/ayong.csv");
setupChart("cc_ucdavis", "adata/ucdavis.csv");
setupChart("cc_umd", "adata/umd.csv");
setupChart("cc_oxford", "adata/oxford.csv");
setupChart("cc_melbournit", "adata/melbournit.csv");
setupChart("cc_8888", "adata/8888.csv");


</script>
</body>

</html>
