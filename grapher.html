<!DOCTYPE html>
<html>
<head>
<title>GlobalPinger</title>

<script src="https://cdn.jsdelivr.net/npm/moment@2/moment.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2/dist/Chart.min.js"></script>
<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.bundle.js"></script>-->

<!--<script src="https://cdn.jsdelivr.net/combine/npm/chart.js@2,npm/moment@2"></script>-->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5/papaparse.min.js"></script>
</head>

<body>

<h1>Overseas Internet Congestion Map</h1>

<h4>Japan</h4>
<p><b>JAIST</b> ftp.jaist.ac.jp</p>
<canvas id="cc_jaist" width="320" height="240"></canvas>


<script>

function setupChart(chart_id, csv_path){
    var ctx=document.getElementById(chart_id).getContext("2d");

    var darray_rtt=[];
    var darray_lrate=[];

    var chart = new Chart(ctx, {
        type: 'scatter',


        data: {
            datasets: [{
                label: 'avg RTT',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: darray_rtt,
                yAxisID:"yax_rtt"
            },
            {
                label: 'Loss %',
                backgroundColor: 'rgb(99, 255, 132)',
                borderColor: 'rgb(99, 255, 132)',
                data: darray_lrate,
                yAxisID:"yax_lrate"
            }]
        },

        options: {
            responsive:false,
            scales: {
                xAxes: [{
                    type: 'time',
                    position: 'bottom',
                    time: {
                        unit:"hour",
                        stepSize:"1"
                    }
                }],
                yAxes: [
                    {
                        id:"yax_rtt",
                        type:"linear",
                        position:"left",
                        ticks:{
                            suggestedMin:0,
                            suggestedMax:400,
                            stepSize:100
                        }
                    },
                    {
                        id:"yax_lrate",
                        type:"linear",
                        position:"right",
                        ticks:{
                            suggestedMin:0,
                            suggestedMax:40,
                            stepSize:10
                        }
                    }
                ]
            }
        }
    });
    
    function dataToChart(datapoints){
            for (var i=0;i<datapoints.length;i++){
                console.log(datapoints[i]);
                var t=new Date(datapoints[i].timestamp*1000)
                darray_rtt.push({
                    'x':t,
                    'y':datapoints[i].rtt_avg
                });
                darray_lrate.push({
                    'x':t,
                    'y':datapoints[i].lossrate*100
                });
                chart.update();
            }
        }

    Papa.parse(csv_path, {
        download: true,
        header:true,
        skipEmptyLines:true,
        complete: function(results) {
                console.log(results);
            
                datapoints=results.data;
                
                dataToChart(datapoints);
            }
    });
}

setupChart("cc_jaist", "data/jaist.csv");


</script>
</body>

</html>
